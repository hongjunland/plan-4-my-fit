name: Performance Monitoring

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build application
        run: pnpm build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_OPENAI_API_KEY: ${{ secrets.VITE_OPENAI_API_KEY }}
          
      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          
      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30

  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build and analyze bundle
        run: |
          pnpm build
          
          # Get bundle sizes
          echo "ðŸ“¦ Bundle Analysis Report" > bundle-report.txt
          echo "=========================" >> bundle-report.txt
          echo "" >> bundle-report.txt
          
          # Main bundle size
          MAIN_SIZE=$(du -h dist/assets/index-*.js | cut -f1)
          echo "Main JS Bundle: $MAIN_SIZE" >> bundle-report.txt
          
          # CSS bundle size
          CSS_SIZE=$(du -h dist/assets/index-*.css | cut -f1)
          echo "Main CSS Bundle: $CSS_SIZE" >> bundle-report.txt
          
          # Total dist size
          TOTAL_SIZE=$(du -sh dist | cut -f1)
          echo "Total Build Size: $TOTAL_SIZE" >> bundle-report.txt
          
          echo "" >> bundle-report.txt
          echo "ðŸ“Š Detailed Breakdown:" >> bundle-report.txt
          echo "=====================" >> bundle-report.txt
          ls -lah dist/assets/ >> bundle-report.txt
          
          cat bundle-report.txt
          
      - name: Comment bundle size on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('bundle-report.txt', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“¦ Bundle Size Report\n\n\`\`\`\n${report}\n\`\`\``
            });

  performance-regression:
    name: Performance Regression Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build current branch
        run: pnpm build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_OPENAI_API_KEY: ${{ secrets.VITE_OPENAI_API_KEY }}
          
      - name: Measure current performance
        run: |
          # Simple performance check - build time and bundle size
          echo "ðŸš€ Performance Metrics" > perf-report.txt
          echo "=====================" >> perf-report.txt
          echo "" >> perf-report.txt
          
          # Build time (approximate from previous step)
          echo "Build completed successfully" >> perf-report.txt
          
          # Bundle sizes
          MAIN_JS=$(find dist/assets -name "index-*.js" -exec du -h {} \; | cut -f1)
          MAIN_CSS=$(find dist/assets -name "index-*.css" -exec du -h {} \; | cut -f1)
          TOTAL=$(du -sh dist | cut -f1)
          
          echo "Main JS: $MAIN_JS" >> perf-report.txt
          echo "Main CSS: $MAIN_CSS" >> perf-report.txt
          echo "Total: $TOTAL" >> perf-report.txt
          
          # Check if bundle is too large (warning threshold)
          MAIN_JS_KB=$(find dist/assets -name "index-*.js" -exec du -k {} \; | cut -f1)
          if [ "$MAIN_JS_KB" -gt 500 ]; then
            echo "" >> perf-report.txt
            echo "âš ï¸  Warning: Main JS bundle is larger than 500KB" >> perf-report.txt
          fi
          
          cat perf-report.txt